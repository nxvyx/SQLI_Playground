<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Injection Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css">
    <style>
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .severity-high { border-left: 4px solid #dc3545; }
        .severity-medium { border-left: 4px solid #ffc107; }
        .severity-low { border-left: 4px solid #0d6efd; }
        .log-entry { 
            font-family: 'Courier New', monospace; 
            font-size: 0.9em;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .severity-badge {
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }
        .badge-high { background-color: #dc3545; }
        .badge-medium { background-color: #ffc107; color: #000; }
        .badge-low { background-color: #0d6efd; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">SQL Injection Dashboard</a>
            <button class="btn btn-outline-light" id="refreshBtn">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Stats Cards -->
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Attack Statistics</h5>
                        <div id="statsContainer">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Last Hour:</span>
                                <span id="lastHour" class="fw-bold">-</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Last 24 Hours:</span>
                                <span id="last24h" class="fw-bold">-</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Last 7 Days:</span>
                                <span id="lastWeek" class="fw-bold">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Severity Distribution -->
            <div class="col-md-5">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Attack Severity</h5>
                        <canvas id="severityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Attackers -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Top Attackers</h5>
                        <div id="topAttackers" class="list-group list-group-flush">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Recent Attack Attempts</h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                            <label class="form-check-label" for="autoRefresh">Auto-refresh</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="attackLogs" style="max-height: 500px; overflow-y: auto;">
                            <!-- Log entries will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script>
        // Global variables
        let severityChart;
        let eventSource;
        let autoRefresh = true;

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial data
            updateStats();
            updateAttackLogs();
            
            // Set up auto-refresh
            setInterval(() => {
                if (autoRefresh) {
                    updateStats();
                    updateAttackLogs();
                }
            }, 5000);
            
            // Set up event listeners
            document.getElementById('autoRefresh').addEventListener('change', function(e) {
                autoRefresh = e.target.checked;
            });
            
            document.getElementById('refreshBtn').addEventListener('click', function() {
                updateStats();
                updateAttackLogs();
            });
            
            // Set up SSE for real-time updates
            setupSSE();
        });
        
        function setupSSE() {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource('/api/logs');
            
            eventSource.onmessage = function(event) {
                if (!autoRefresh) return;
                
                const attack = JSON.parse(event.data);
                addAttackToLog(attack);
            };
            
            eventSource.onerror = function() {
                console.error('SSE error');
                // Try to reconnect after 5 seconds
                setTimeout(setupSSE, 5000);
            };
        }
        
        function updateStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    // Update stats cards
                    document.getElementById('lastHour').textContent = data.last_hour;
                    document.getElementById('last24h').textContent = data.last_24h;
                    document.getElementById('lastWeek').textContent = data.last_week;
                    
                    // Update severity chart
                    updateSeverityChart(data.by_severity);
                    
                    // Update top attackers
                    updateTopAttackers(data.by_ip);
                })
                .catch(error => console.error('Error fetching stats:', error));
        }
        
        function updateSeverityChart(severityData) {
            const ctx = document.getElementById('severityChart').getContext('2d');
            
            if (severityChart) {
                // Update existing chart
                severityChart.data.datasets[0].data = [
                    severityData.high || 0,
                    severityData.medium || 0,
                    severityData.low || 0
                ];
                severityChart.update();
            } else {
                // Create new chart
                severityChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['High', 'Medium', 'Low'],
                        datasets: [{
                            data: [
                                severityData.high || 0,
                                severityData.medium || 0,
                                severityData.low || 0
                            ],
                            backgroundColor: [
                                '#dc3545',
                                '#ffc107',
                                '#0d6efd'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }
        
        function updateTopAttackers(attackers) {
            const container = document.getElementById('topAttackers');
            container.innerHTML = '';
            
            attackers.forEach(attacker => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                
                const ipSpan = document.createElement('span');
                ipSpan.textContent = attacker.ip;
                
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary rounded-pill';
                badge.textContent = attacker.count;
                
                item.appendChild(ipSpan);
                item.appendChild(badge);
                container.appendChild(item);
            });
        }
        
        function updateAttackLogs() {
            fetch('/api/attacks')
                .then(response => response.json())
                .then(attacks => {
                    const container = document.getElementById('attackLogs');
                    container.innerHTML = '';
                    
                    attacks.forEach(attack => {
                        addAttackToLog(attack);
                    });
                })
                .catch(error => console.error('Error fetching attack logs:', error));
        }
        
        function addAttackToLog(attack) {
            const container = document.getElementById('attackLogs');
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = new Date(attack.timestamp).toLocaleString();
            const severity = attack.details?.severity || 'unknown';
            
            let severityClass = '';
            let severityText = '';
            
            switch(severity.toLowerCase()) {
                case 'high':
                    severityClass = 'severity-high';
                    severityText = 'High';
                    break;
                case 'medium':
                    severityClass = 'severity-medium';
                    severityText = 'Medium';
                    break;
                case 'low':
                    severityClass = 'severity-low';
                    severityText = 'Low';
                    break;
                default:
                    severityClass = '';
                    severityText = 'Unknown';
            }
            
            logEntry.innerHTML = `
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">${timestamp}</span>
                    <span class="severity-badge badge-${severity.toLowerCase()}">${severityText}</span>
                </div>
                <div><strong>IP:</strong> ${attack.ip}</div>
                <div class="text-muted">${JSON.stringify(attack.details || {})}</div>
            `;
            
            // Add to the top of the container
            if (container.firstChild) {
                container.insertBefore(logEntry, container.firstChild);
            } else {
                container.appendChild(logEntry);
            }
        }
    </script>
</body>
</html>