{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Tutorial Navigation -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">SQL Injection Learning Path</h4>
                </div>
                <div class="card-body">
                    <div class="btn-group mb-3" role="group" aria-label="Tutorial navigation">
                        <button type="button" class="btn btn-outline-primary active" onclick="showLesson('basics', this)">Basics</button>
                        <button type="button" class="btn btn-outline-primary" onclick="showLesson('payloads', this)">Payloads</button>
                        <button type="button" class="btn btn-outline-primary" onclick="showLesson('detection', this)">Detection</button>
                        <button type="button" class="btn btn-outline-primary" onclick="showLesson('defense', this)">Defense</button>
                        <button type="button" class="btn btn-outline-primary" onclick="showLesson('cheatsheet', this)">Cheat Sheet</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Basics Lesson -->
    <div id="lesson-basics" class="lesson-content">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Lesson 1: SQL Injection Basics</h5>
                    </div>
                    <div class="card-body">
                        <h6>What is SQL Injection?</h6>
                        <p>SQL Injection (SQLi) is a code injection technique where an attacker inserts malicious SQL statements into an entry field, allowing them to manipulate the database query and potentially:</p>
                        <ul>
                            <li>Bypass authentication</li>
                            <li>Extract sensitive data</li>
                            <li>Modify or delete data</li>
                            <li>Execute administrative operations</li>
                        </ul>

                        <h6 class="mt-4">How It Works</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p><strong>Normal Query:</strong></p>
                                <pre class="mb-2"><code class="language-sql copyable">SELECT * FROM users WHERE username='admin' AND password='pass123'</code></pre>

                                <p class="mt-3"><strong>With SQLi Payload:</strong></p>
                                <pre class="mb-2"><code class="language-sql copyable">SELECT * FROM users WHERE username='admin' AND password='' OR '1'='1'</code></pre>

                                <p class="mt-3"><strong>Result:</strong> The condition becomes always true, bypassing authentication!</p>
                            </div>
                        </div>

                        <h6 class="mt-4">Why It's Dangerous</h6>
                        <ul>
                            <li>Affects millions of web applications</li>
                            <li>Often ranked in OWASP Top 10</li>
                            <li>Can lead to complete database compromise</li>
                            <li>Relatively easy to execute with proper knowledge</li>
                        </ul>

                        <div class="mt-4">
                            <a href="{{ url_for('login') }}" class="btn btn-danger">Try Vulnerable Login</a>
                            <a href="{{ url_for('secure_login_route') }}" class="btn btn-success">See Secure Version</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payloads Lesson -->
    <div id="lesson-payloads" class="lesson-content" style="display:none;">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Lesson 2: Common SQL Injection Payloads</h5>
                    </div>
                    <div class="card-body">
                        <h6>1. Authentication Bypass (Tautology)</h6>
                        <div class="card bg-light mb-3">
                            <div class="card-body small">
                                <p><strong>Payload:</strong> <code class="copyable">admin' OR '1'='1</code>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" data-payload="admin' OR '1'='1" onclick="tryPayloadFromButton(this)">Try</button>
                                </p>
                                <p><strong>Effect:</strong> Makes the WHERE clause always true</p>
                                <p><strong>Example:</strong><br/>
                                <code>SELECT * FROM users WHERE username='admin' OR '1'='1'</code></p>
                            </div>
                        </div>

                        <h6>2. UNION-Based Extraction</h6>
                        <div class="card bg-light mb-3">
                            <div class="card-body small">
                                <p><strong>Payload:</strong> <code class="copyable">' UNION SELECT username, password FROM users--</code>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" data-payload="' UNION SELECT username, password FROM users--" onclick="tryPayloadFromButton(this)">Try</button>
                                </p>
                                <p><strong>Effect:</strong> Combines results from different tables</p>
                                <p><strong>Purpose:</strong> Extract data from other tables</p>
                            </div>
                        </div>

                        <h6>3. Comment-Based Bypass</h6>
                        <div class="card bg-light mb-3">
                            <div class="card-body small">
                                <p><strong>Payload:</strong> <code class="copyable">admin'--</code>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" data-payload="admin'--" onclick="tryPayloadFromButton(this)">Try</button>
                                </p>
                                <p><strong>Effect:</strong> Comments out the rest of the query with --</p>
                                <p><strong>Example:</strong><br/>
                                <code>SELECT * FROM users WHERE username='admin'-- AND password='xxx'</code></p>
                            </div>
                        </div>

                        <h6>4. Time-Based Blind SQLi</h6>
                        <div class="card bg-light mb-3">
                            <div class="card-body small">
                                <p><strong>Payload:</strong> <code class="copyable">' AND SLEEP(5)--</code>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" data-payload="' AND SLEEP(5)--" onclick="tryPayloadFromButton(this)">Try</button>
                                </p>
                                <p><strong>Effect:</strong> Causes database to delay response</p>
                                <p><strong>Purpose:</strong> Extract data without seeing it (blind SQLi)</p>
                            </div>
                        </div>

                        <h6>5. Stacked Queries</h6>
                        <div class="card bg-light mb-3">
                            <div class="card-body small">
                                <p><strong>Payload:</strong> <code class="copyable">'; DROP TABLE users;--</code>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" data-payload="'; DROP TABLE users;--" onclick="tryPayloadFromButton(this)">Try</button>
                                </p>
                                <p><strong>Effect:</strong> Executes multiple SQL statements</p>
                                <p><strong>Warning:</strong> DESTRUCTIVE! Do not use on real systems</p>
                            </div>
                        </div>

                        <div class="alert alert-warning mt-4">
                            <strong>Educational Note:</strong> These payloads are for learning purposes only. Use them only on your own systems or authorized penetration testing environments!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detection Lesson -->
    <div id="lesson-detection" class="lesson-content" style="display:none;">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Lesson 3: SQLi Detection Methods</h5>
                    </div>
                    <div class="card-body">
                        <h6>Pattern-Based Detection</h6>
                        <p>Looking for SQL keywords and suspicious patterns:</p>
                        <ul class="small">
                            <li><strong>SQL Keywords:</strong> SELECT, UNION, DROP, INSERT, DELETE, UPDATE</li>
                            <li><strong>Comments:</strong> -- (SQL comment), /* */ (block comment)</li>
                            <li><strong>Operators:</strong> OR, AND combined with quotes</li>
                            <li><strong>Functions:</strong> SLEEP(), WAITFOR(), BENCHMARK()</li>
                        </ul>

                        <h6 class="mt-4">Behavioral Detection</h6>
                        <ul class="small">
                            <li><strong>Response Time Analysis:</strong> Detect SLEEP/WAITFOR delays</li>
                            <li><strong>Error Messages:</strong> Database errors reveal structure</li>
                            <li><strong>Data Volume:</strong> Unusual amount of data returned</li>
                            <li><strong>Query Patterns:</strong> Anomalous SQL structures</li>
                        </ul>

                        <h6 class="mt-4">Detection Score Calculation</h6>
                        <div class="card bg-light">
                            <div class="card-body small">
                                <p>This playground uses a scoring system:</p>
                                <ul>
                                    <li><strong>1 pattern matched:</strong> LOW severity</li>
                                    <li><strong>2-3 patterns matched:</strong> MEDIUM severity</li>
                                    <li><strong>4+ patterns matched:</strong> HIGH severity</li>
                                </ul>
                            </div>
                        </div>

                        <h6 class="mt-4">Try It Yourself</h6>
                        <p>Visit the <a href="{{ url_for('search') }}">vulnerable search page</a> and watch how different payloads are detected with different severity levels.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Defense Lesson -->
    <div id="lesson-defense" class="lesson-content" style="display:none;">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Lesson 4: SQL Injection Defense</h5>
                    </div>
                    <div class="card-body">
                        <h6>1. Parameterized Queries (Best Practice)</h6>
                        <div class="card bg-light mb-3">
                            <div class="card-body small">
                                <p><strong>Good:</strong></p>
                                <pre class="mb-2"><code class="language-sql copyable">cursor.execute("SELECT * FROM users WHERE username=? AND password=?", (username, password))</code></pre>

                                <p class="mt-2"><strong>Why it works:</strong> SQL structure is separate from user input</p>
                            </div>
                        </div>

                        <h6>2. Input Validation</h6>
                        <div class="card bg-light mb-3">
                            <div class="card-body small">
                                <p><strong>Whitelist Approach:</strong></p>
                                <pre class="mb-2"><code class="language-python copyable">if re.match(r'^[a-zA-Z0-9_]+$', username):
    # accept only letters, numbers and underscore
    return True
else:
    return False
</code></pre>

                                <p class="mt-2"><strong>Benefits:</strong> Only allow expected characters</p>
                            </div>
                        </div>

                        <h6>3. Least Privilege Principle</h6>
                        <div class="card bg-light mb-3">
                            <div class="card-body small">
                                <p>Create database users with minimal required permissions:</p>
                                <ul>
                                    <li>Read-only user for SELECT queries</li>
                                    <li>Separate user for INSERT/UPDATE operations</li>
                                    <li>No admin/DROP permissions for application users</li>
                                </ul>
                            </div>
                        </div>

                        <h6>4. Web Application Firewall (WAF)</h6>
                        <div class="card bg-light mb-3">
                            <div class="card-body small">
                                <p>Deploy WAF rules to:</p>
                                <ul>
                                    <li>Block requests with SQL keywords</li>
                                    <li>Rate limit suspicious patterns</li>
                                    <li>Monitor for attack signatures</li>
                                </ul>
                            </div>
                        </div>

                        <h6>5. Error Handling</h6>
                        <div class="card bg-light mb-3">
                            <div class="card-body small">
                                <p><strong>Never expose database errors to users:</strong></p>
                                <pre class="mb-2"><code class="language-python copyable">try:
    # database operation
    pass
except Exception:
    # return a generic message, log details internally
    return "Database error occurred"
</code></pre>

                                <p class="mt-2"><strong>Why:</strong> Error messages can reveal database structure</p>
                            </div>
                        </div>

                        <div class="mt-4">
                            <a href="{{ url_for('secure_login_route') }}" class="btn btn-success">See Secure Implementation</a>
                            <a href="{{ url_for('secure_search') }}" class="btn btn-success">See Secure Search</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cheat Sheet -->
    <div id="lesson-cheatsheet" class="lesson-content" style="display:none;">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>SQL Injection Cheat Sheet</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Example Payload</th>
                                        <th>Purpose</th>
                                        <th>Difficulty</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Tautology</strong></td>
                                        <td><code class="copyable">' OR '1'='1</code></td>
                                        <td>Bypass authentication</td>
                                        <td><span class="badge bg-success">Easy</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Comment Injection</strong></td>
                                        <td><code class="copyable">admin'--</code></td>
                                        <td>Comment out query part</td>
                                        <td><span class="badge bg-success">Easy</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>UNION-based</strong></td>
                                        <td><code class="copyable">' UNION SELECT ...--</code></td>
                                        <td>Extract data</td>
                                        <td><span class="badge bg-warning">Medium</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Time-based Blind</strong></td>
                                        <td><code class="copyable">' AND SLEEP(5)--</code></td>
                                        <td>Blind data extraction</td>
                                        <td><span class="badge bg-warning">Medium</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Boolean-based Blind</strong></td>
                                        <td><code class="copyable">' AND 1=1--</code></td>
                                        <td>Blind data extraction</td>
                                        <td><span class="badge bg-warning">Medium</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Stacked Queries</strong></td>
                                        <td><code class="copyable">'; DROP TABLE ...;--</code></td>
                                        <td>Execute multiple queries</td>
                                        <td><span class="badge bg-danger">Hard</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h6 class="mt-4">Prevention Checklist</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" disabled checked>
                            <label class="form-check-label">Use parameterized queries</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" disabled checked>
                            <label class="form-check-label">Validate all user input</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" disabled checked>
                            <label class="form-check-label">Use least privilege principle</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" disabled checked>
                            <label class="form-check-label">Implement error handling</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" disabled checked>
                            <label class="form-check-label">Deploy WAF rules</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" disabled checked>
                            <label class="form-check-label">Regular security testing</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .lesson-content {
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .btn-group .btn {
        margin: 2px;
    }
</style>

<!-- Highlight.js for code highlighting (CDN) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>
function showLesson(lessonId, btn) {
    // Hide all lessons
    document.querySelectorAll('.lesson-content').forEach(el => el.style.display = 'none');

    // Show selected lesson
    const target = document.getElementById(`lesson-${lessonId}`);
    if (target) target.style.display = 'block';

    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
    if (btn && btn.classList) btn.classList.add('active');
}

function tryPayloadFromButton(btn) {
    const payload = btn.getAttribute('data-payload') || '';
    if (!payload) return;
    const url = `/api/search?q=${encodeURIComponent(payload)}`;
    window.open(url, '_blank');
}

function addCopyButtons() {
    document.querySelectorAll('code.copyable').forEach(codeEl => {
        // Avoid adding multiple buttons
        if (codeEl.parentNode && codeEl.parentNode.querySelector('.copy-btn')) return;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-sm btn-outline-primary ms-2 copy-btn';
        btn.innerText = 'Copy';
        btn.addEventListener('click', () => {
            const text = codeEl.innerText;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    btn.innerText = 'Copied';
                    setTimeout(() => btn.innerText = 'Copy', 1500);
                });
            } else {
                // fallback
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
            }
        });

        // If code is inside a pre, append button to pre; else append after code
        const parent = codeEl.closest('pre');
        if (parent) parent.parentNode.insertBefore(btn, parent.nextSibling);
        else codeEl.parentNode.insertBefore(btn, codeEl.nextSibling);
    });
}

document.addEventListener('DOMContentLoaded', () => {
    // Initialize code highlighting
    if (window.hljs) hljs.highlightAll();

    // Add copy buttons to copyable code blocks
    addCopyButtons();
});
</script>
{% endblock %}
